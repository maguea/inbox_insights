{% extends "base.html" %}

{% block title %}Login{% endblock %}

{% block page_content %}
<div class="page-header mb-4">
    <h1 id="pageTitle">Login</h1>
</div>

<div id="statusMsg" class="alert d-none" role="alert"></div>

<div class="card">
    <div class="card-body">
        <form id="emailForm">
            <div class="mb-3">
                <label for="user" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="user" name="user"
                    placeholder="{% if user %}{{ user }}{% else %}mail@example.com{% endif %}"
                    value="{% if user %}{{ user }}{% endif %}" required>
                <div class="form-text">Your full email address</div>
            </div>

            <div class="mb-3">
                <label for="pass" class="form-label">
                    Account Password
                </label>
                <!-- name MUST be 'key' to match email_login() -->
                <input type="password" class="form-control" id="pass" name="key" placeholder="Your account password">
                <div class="form-text">
                    Use the normal password you use for this account.
                </div>
            </div>

            {# --- IMAP server option block --- #}
            <div class="mb-3">
                <label class="form-label">IMAP Server (optional)</label>
                <div class="btn-group" role="group" aria-label="IMAP Server selection">
                    {% if user %}
                    {% set domain = user.split('@')[-1] %}
                    {% else %}
                    {% set domain = '' %}
                    {% endif %}

                    <input type="radio" class="btn-check" name="server" id="gmail" value="imap.gmail.com" {% if not user
                        or 'gmail.com' in domain %}checked{% endif %}>
                    <label class="btn btn-outline-primary" for="gmail">Gmail</label>

                    <input type="radio" class="btn-check" name="server" id="outlook" value="outlook.office365.com" {%
                        if 'outlook.com' in domain or 'hotmail.com' in domain or 'live.com' in domain or 'office365.com'
                        in domain %}checked{% endif %}>
                    <label class="btn btn-outline-primary" for="outlook">Outlook</label>
                </div>
                <div class="form-text mt-2">
                    Choose your provider if you want to save which IMAP server to use.
                </div>
            </div>
            {# --- end IMAP block --- #}

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    Login
                </button>

                <button type="button" class="btn btn-outline-secondary" id="createBtn">
                    Create Account
                </button>
            </div>

        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('emailForm');
        const loginBtn = document.getElementById('submitBtn');
        const createBtn = document.getElementById('createBtn');
        const title = document.getElementById('pageTitle');
        const statusMsg = document.getElementById('statusMsg');

        function resetStatus() {
            statusMsg.classList.add('d-none');
            statusMsg.classList.remove('alert-success', 'alert-danger', 'alert-info');
            statusMsg.textContent = '';
        }

        // ----------------- LOGIN -----------------
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            resetStatus();

            const formData = new FormData(form);

            try {
                const resp = await fetch('{{ url_for("api.check_user_account") }}', {
                    method: 'POST',
                    body: formData
                });

                const data = await resp.json();
                statusMsg.classList.remove('d-none');

                if (data.ok === true) {
                    window.location.href = '{{ url_for("index") }}';   // SUCCESS REDIRECT
                } else {
                    statusMsg.classList.add('alert', 'alert-danger');
                    statusMsg.textContent = data.msg || 'Invalid credentials. Please try again.';
                }
            } catch (err) {
                statusMsg.classList.remove('d-none');
                statusMsg.classList.add('alert', 'alert-danger');
                statusMsg.textContent = 'There was a problem contacting the server.';
                console.error(err);
            }
        });

        // ----------------- CREATE ACCOUNT -----------------
        createBtn.addEventListener('click', async () => {
            resetStatus();

            const userEl = document.getElementById('user');
            const passEl = document.getElementById('pass');
            const serverEl = document.querySelector('input[name="server"]:checked');

            const fd = new FormData();
            fd.append('username', (userEl.value || '').trim());
            fd.append('password', passEl.value || '');
            fd.append('server', serverEl ? serverEl.value : '');

            try {
                const resp = await fetch('{{ url_for("login.login_submit") }}', {
                    method: 'POST',
                    body: fd
                });

                const data = await resp.json();
                statusMsg.classList.remove('d-none');

                if (data.ok === true) {
                    window.location.href = '{{ url_for("index") }}';   // SUCCESS REDIRECT
                } else {
                    statusMsg.classList.add('alert', 'alert-danger');
                    statusMsg.textContent = data.msg || 'Unable to create account.';
                }
            } catch (err) {
                statusMsg.classList.remove('d-none');
                statusMsg.classList.add('alert', 'alert-danger');
                statusMsg.textContent = 'There was a problem creating your account.';
                console.error(err);
            }
        });
    });
</script>


{% endblock %}