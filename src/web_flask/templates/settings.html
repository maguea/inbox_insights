{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block page_content %}
<div class="page-header mb-4">
    <h1>Email Settings</h1>
    <p class="text-muted">
        {% if user %}
        Manage your email account connection
        {% else %}
        Set up your email account
        {% endif %}
    </p>
</div>

{% if user %}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <strong>Current Status:</strong>
    <span id="connectionStatus">
        <span class="spinner-border spinner-border-sm" role="status"></span> Checking connection...
    </span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div id="successAlert" class="alert alert-success alert-dismissible fade show d-none" role="alert">
    <strong>Success!</strong>
    <span id="successMessage">
        {% if user %}
        Email credentials updated and connection verified!
        {% else %}
        Email account set up successfully!
        {% endif %}
    </span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<div id="errorAlert" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
    <strong>Error:</strong> <span id="errorMessage"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<div class="card">
    <div class="card-body">
        <form id="emailForm">
            <div class="mb-3">
                <label for="user" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="user" name="user"
                    placeholder="{% if user %}{{ user }}{% else %}mail@example.com{% endif %}"
                    value="{% if user %}{{ user }}{% endif %}" required>
                <div class="form-text">Your full email address</div>
            </div>

            <div class="mb-3">
                <label for="key" class="form-label">
                    App Password / Key
                </label>
                <input type="password" class="form-control" id="key" name="key"
                    placeholder="Your email app password or API key" required>
                <div class="form-text">
                    Use your email provider's app password or generated key (not your normal login password).
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">IMAP Server</label>
                <div class="btn-group" role="group" aria-label="IMAP Server selection">
                    {# derive domain from the email string if present #}
                    {% if user %}
                    {% set domain = user.split('@')[-1] %}
                    {% else %}
                    {% set domain = '' %}
                    {% endif %}

                    <input type="radio" class="btn-check" name="server" id="gmail" value="imap.gmail.com" {# default to
                        Gmail if no user yet or if email looks like a Gmail address #} {% if not user or 'gmail.com' in
                        domain %} checked {% endif %}>
                    <label class="btn btn-outline-primary" for="gmail">Gmail</label>

                    <input type="radio" class="btn-check" name="server" id="outlook" value="outlook.office365.com" {#
                        default to Outlook if email domain looks like an Outlook/Microsoft one #} {% if 'outlook.com' in
                        domain or 'hotmail.com' in domain or 'live.com' in domain or 'office365.com' in domain %}
                        checked {% endif %}>
                    <label class="btn btn-outline-primary" for="outlook">Outlook</label>
                </div>
                <div class="form-text mt-2">Select your email provider</div>
            </div>


            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    {% if user %}
                    Update Email
                    {% else %}
                    Save & Connect
                    {% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">Connection Help</h5>
    </div>
    <div class="card-body">
        <h6>App Passwords:</h6>
        <p class="mb-0">
            For Gmail and other services, you may need to generate an App Password instead of using your regular
            password.
        </p>
    </div>
</div>

<script>
    document.getElementById('emailForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;

        document.getElementById('successAlert').classList.add('d-none');
        document.getElementById('errorAlert').classList.add('d-none');

        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Testing Connection...';
        submitBtn.disabled = true;

        try {
            const formData = new FormData(this);

            const response = await fetch('{{ url_for("api.add_email") }}', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok && result.ok) {
                document.getElementById('successMessage').textContent =
                    result.msg || 'Email settings saved successfully!';
                document.getElementById('successAlert').classList.remove('d-none');

                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                document.getElementById('errorMessage').textContent =
                    result.msg || 'An error occurred while saving settings';
                document.getElementById('errorAlert').classList.remove('d-none');
            }

        } catch (error) {
            console.error('Error:', error);
            document.getElementById('errorMessage').textContent = 'Network error: Unable to connect to server';
            document.getElementById('errorAlert').classList.remove('d-none');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        {% if user %}
        const statusElement = document.getElementById('connectionStatus');

        fetch('{{ url_for("api.check_email_account") }}', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                console.log('Current email status:', data);

                const alertElement = statusElement.closest('.alert');

                if (data.ok) {
                    statusElement.innerHTML = data.msg || 'Connected';
                    alertElement.classList.remove('alert-warning', 'alert-danger');
                    alertElement.classList.add('alert-success');
                } else {
                    statusElement.innerHTML = data.msg || 'Not connected';
                    alertElement.classList.remove('alert-warning', 'alert-success');
                    alertElement.classList.add('alert-danger');
                }
            })
            .catch(error => {
                console.error('Error checking email status:', error);
                statusElement.innerHTML = 'Error checking connection status';
                const alertElement = statusElement.closest('.alert');
                alertElement.classList.remove('alert-warning', 'alert-success');
                alertElement.classList.add('alert-danger');
            });
        {% endif %}
    });
</script>
{% endblock %}