{#Isaac Tucker#}
{% extends "base.html" %}

{% block title %}Email Settings{% endblock %}

{% block page_content %}
<div class="page-header mb-4">
    <h1>Email Settings</h1>
    <p class="text-muted">
        Manage your email account connection and cleanup rules.
    </p>
</div>

<div class="alert alert-success d-none" id="successAlert">
    <span id="successMessage"></span>
</div>
<div class="alert alert-danger d-none" id="errorAlert">
    <span id="errorMessage"></span>
</div>

<!-- ACCOUNT / CONNECTION CARD -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Account &amp; Connection</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive mb-2">
            <table class="table align-middle settings-table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Username</th>
                        <th style="width: 20%;">Password</th>
                        <th style="width: 25%;">App Key</th>
                        <th style="width: 15%;">Server</th>
                        <th style="width: 15%;" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <!-- Username -->
                        <td>
                            <input type="email" class="form-control" id="user" name="user"
                                   placeholder="mail@example.com" value="{% if user %}{{ user }}{% endif %}" {% if user
                                %}readonly{% endif %}>
                            <div class="form-text">Stored account email</div>
                        </td>

                        <!-- Password (display-only / not used) -->
                        <td>
                            <input type="password" class="form-control" id="password" name="password"
                                placeholder="••••••••">
                            <div class="form-text">Local password (if you use one).</div>
                        </td>

                        <!-- App Key -->
                        <td>
                            <input type="password" class="form-control" id="appKey" name="key"
                                placeholder="Email app password/key">
                            <div class="form-text">
                                Typically generated from your email provider for IMAP access.
                            </div>
                        </td>

                        <!-- Server -->
                        <td>
                            <select id="server" name="server" class="form-select">
                                <option value="gmail">Gmail</option>
                                <option value="outlook">Outlook</option>
                                <option value="yahoo">Yahoo</option>
                                <option value="other">Other</option>
                            </select>
                            <div class="form-text">Choose your email server.</div>
                        </td>

                        <!-- Actions -->
                        <td class="text-end">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="btnVerify">
                                    Verify Login
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="btnSaveKey">
                                    Save App Key
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" id="btnUpdateEmails">
                                    Update Emails
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <small class="text-muted d-block mt-2">
            “Verify Login” only checks your credentials. “Save App Key” saves and verifies.
            “Update Emails” pulls new messages into the database.
        </small>
    </div>
</div>

<!-- CATEGORIES CARD -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Categories</h5>
        <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddCategory">
            Add Category
        </button>
    </div>
    <div class="card-body">
        <div class="table-responsive mb-2">
            <table class="table align-middle settings-table" id="categoriesTable">
                <thead>
                    <tr>
                        <th style="width: 20%;">Name</th>
                        <th style="width: 10%;">Color</th>
                        <th style="width: 40%;">Emails / Domains</th>
                        <th style="width: 15%;">Delete After (days)</th>
                        <th style="width: 15%;" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="categoriesBody">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
        <small class="text-muted">
            Separate multiple emails/domains with commas. “Delete After” controls how long to keep messages
            in this category before deletion.
        </small>
    </div>
</div>

<style>
    /* Light-mode header look */
    .settings-table thead th {
        background-color: #f8fafc;
        color: #111827;
        border-bottom-width: 1px;
    }

    /* Dark-mode header override */
    body.dark-mode .settings-table thead th {
        background-color: #020617;
        color: #e5e7eb;
        border-color: #1e293b;
    }
</style>

<script>
    (function () {
        const successAlert = document.getElementById('successAlert');
        const successMessage = document.getElementById('successMessage');
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');
        const connectionBadge = document.getElementById('connectionStatus');

        function showSuccess(msg) {
            successMessage.textContent = msg || 'Success.';
            successAlert.classList.remove('d-none');
            errorAlert.classList.add('d-none');
        }

        function showError(msg) {
            errorMessage.textContent = msg || 'Something went wrong.';
            errorAlert.classList.remove('d-none');
            successAlert.classList.add('d-none');
        }

        function clearAlerts() {
            successAlert.classList.add('d-none');
            errorAlert.classList.add('d-none');
        }

        function setConnectionChecking() {
            if (!connectionBadge) return;
            connectionBadge.className = 'badge bg-secondary';
            connectionBadge.innerHTML =
                '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Checking';
        }

        function setConnectionStatus(ok, msg) {
            if (!connectionBadge) return;
            if (ok) {
                connectionBadge.className = 'badge bg-success';
                connectionBadge.textContent = msg || 'Connected';
            } else {
                connectionBadge.className = 'badge bg-danger';
                connectionBadge.textContent = msg || 'Not connected';
            }
        }

        const btnVerify = document.getElementById('btnVerify');
        const btnSaveKey = document.getElementById('btnSaveKey');
        const btnUpdateEmails = document.getElementById('btnUpdateEmails');

        function getLoginPayload() {
            return {
                user: document.getElementById('user').value.trim(),
                pass: document.getElementById('appKey').value.trim(),
                server: document.getElementById('server').value
            };
        }

        if (btnVerify) {
            btnVerify.addEventListener('click', async () => {
                const payload = getLoginPayload();
                if (!payload.user) {
                    showError('Username is required to verify login.');
                    setConnectionStatus(false, 'Not connected');
                    return;
                }

                setConnectionChecking();

                try {
                    const resp = await fetch('{{ url_for("api.check_email_account") }}', {
                        method: 'GET'
                    });
                    const data = await resp.json();
                    if (resp.ok && data.ok) {
                        showSuccess(data.msg || 'Login verified successfully.');
                        setConnectionStatus(true, data.msg || 'Connected');
                    } else {
                        showError(data.msg || 'Login verification failed.');
                        setConnectionStatus(false, data.msg || 'Not connected');
                    }
                } catch (e) {
                    console.error(e);
                    showError('Network error while checking connection.');
                    setConnectionStatus(false, 'Not connected');
                }
            });
        }

        if (btnSaveKey) {
            btnSaveKey.addEventListener('click', async () => {
                clearAlerts();
                const payload = getLoginPayload();
                if (!payload.user || !payload.pass || !payload.server) {
                    showError('Username, app key, and server are required to save.');
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append('user', payload.user);
                    formData.append('key', payload.pass);
                    formData.append('server', payload.server);

                    const resp = await fetch('{{ url_for("api.save_key") }}', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await resp.json();
                    if (resp.ok && data.ok) {
                        showSuccess(data.msg || 'App key saved and verified.');
                        setConnectionStatus(true, data.msg || 'Connected');
                    } else {
                        showError(data.msg || 'Failed to save app key.');
                        setConnectionStatus(false, data.msg || 'Not connected');
                    }
                } catch (err) {
                    console.error(err);
                    showError('Network error while saving key.');
                    setConnectionStatus(false, 'Not connected');
                }
            });
        }

        if (btnUpdateEmails) {
            btnUpdateEmails.addEventListener('click', async () => {
                clearAlerts();
                try {
                    const resp = await fetch('{{ url_for("api.update_emails") }}', {
                        method: 'POST'
                    });
                    const data = await resp.json();
                    if (resp.ok && data.ok) {
                        showSuccess(data.msg || 'Emails updated.');
                    } else {
                        showError(data.msg || 'Failed to update emails.');
                    }
                } catch (err) {
                    console.error(err);
                    showError('Network error while updating emails.');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async function () {
            if (!connectionBadge) return;

            setConnectionChecking();

            try {
                const resp = await fetch('{{ url_for("api.check_email_account") }}', {
                    method: 'GET'
                });
                const data = await resp.json();
                if (resp.ok && data.ok) {
                    setConnectionStatus(true, data.msg || 'Connected');
                } else {
                    if (data && data.msg) {
                        showError(data.msg);
                    }
                    setConnectionStatus(false, data.msg || 'Not connected');
                }
            } catch (e) {
                console.error(e);
                showError('Network error while checking connection.');
                setConnectionStatus(false, 'Not connected');
            }
        });

        const categoriesBody = document.getElementById('categoriesBody');
        const btnAddCategory = document.getElementById('btnAddCategory');

        function renderCategoryRow(cat) {
            const tr = document.createElement('tr');
            tr.dataset.name = cat.name || '';

            tr.innerHTML = `
            <td>
                <input type="text" class="form-control category-name" value="${cat.name || ''}" ${cat.name ? 'readonly' : ''}>
            </td>
            <td>
                <input type="color" class="form-control form-control-color category-color"
                       value="${cat.color || '#4a90e2'}" title="Pick category color">
            </td>
            <td>
                <textarea class="form-control category-emails" rows="2"
                    placeholder="user@example.com, @domain.com">${(cat.emails || []).join(', ')}</textarea>
            </td>
            <td>
                <input type="number" min="0" class="form-control category-days"
                       value="${cat.days_until_delete != null ? cat.days_until_delete : ''}"
                       placeholder="e.g., 30">
            </td>
            <td class="text-end">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary btn-save-category">
                        Save
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-delete-category">
                        Delete
                    </button>
                </div>
            </td>
        `;
            return tr;
        }

        async function loadCategories() {
            categoriesBody.innerHTML = `
            <tr><td colspan="5" class="text-center text-muted py-3">
                Loading categories...
            </td></tr>
        `;
            try {
                const resp = await fetch('{{ url_for("api.categories_list") }}');
                const data = await resp.json();
                if (!resp.ok || !data.ok) {
                    throw new Error(data.msg || 'Failed to load categories');
                }
                const categories = data.categories || [];
                categoriesBody.innerHTML = '';
                if (!categories.length) {
                    categoriesBody.innerHTML = `
                    <tr><td colspan="5" class="text-center text-muted py-3">
                        No categories yet. Click "Add Category" to create one.
                    </td></tr>
                `;
                } else {
                    categories.forEach(cat => {
                        categoriesBody.appendChild(renderCategoryRow(cat));
                    });
                }
            } catch (err) {
                console.error(err);
                categoriesBody.innerHTML = `
                <tr><td colspan="5" class="text-center text-danger py-3">
                    Failed to load categories.
                </td></tr>
            `;
            }
        }

        if (btnAddCategory) {
            btnAddCategory.addEventListener('click', () => {
                const tr = renderCategoryRow({ name: '', emails: [], days_until_delete: '', color: '#4a90e2' });
                categoriesBody.prepend(tr);
            });
        }

        categoriesBody.addEventListener('click', async (e) => {
            const target = e.target;
            const row = target.closest('tr');
            if (!row) return;

            if (target.classList.contains('btn-save-category')) {
                const nameInput = row.querySelector('.category-name');
                const emailsInput = row.querySelector('.category-emails');
                const daysInput = row.querySelector('.category-days');
                const colorInput = row.querySelector('.category-color');

                const name = nameInput.value.trim();
                const emails = emailsInput.value.split(',')
                    .map(s => s.trim())
                    .filter(Boolean);
                const days = daysInput.value.trim();
                const color = (colorInput && colorInput.value) ? colorInput.value : '#4a90e2';

                if (!name) {
                    showError('Category name is required.');
                    return;
                }

                try {
                    const resp = await fetch('{{ url_for("api.categories_upsert") }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name,
                            emails,
                            days_until_delete: days || null,
                            color
                        })
                    });
                    const data = await resp.json();
                    if (resp.ok && data.ok) {
                        showSuccess('Category saved.');
                        loadCategories();
                    } else {
                        showError(data.msg || 'Failed to save category.');
                    }
                } catch (err) {
                    console.error(err);
                    showError('Network error while saving category.');
                }
            }

            if (target.classList.contains('btn-delete-category')) {
                const nameInput = row.querySelector('.category-name');
                const name = (nameInput.value || '').trim();

                if (!name) {
                    showError('Cannot delete a category with no name.');
                    return;
                }

                if (!confirm(`Delete category "${name}"?`)) {
                    return;
                }

                try {
                    const resp = await fetch(`{{ url_for("api.categories_delete", name="__NAME__") }}`.replace('__NAME__', encodeURIComponent(name)), {
                        method: 'DELETE'
                    });
                    const data = await resp.json();
                    if (resp.ok && data.ok) {
                        showSuccess('Category deleted.');
                        row.remove();
                    } else {
                        showError(data.msg || 'Failed to delete category.');
                    }
                } catch (err) {
                    console.error(err);
                    showError('Network error while deleting category.');
                }
            }
        });

        loadCategories();
    })();
</script>
{% endblock %}
